<style>
#tbl_periksa_lab th, #tbl_periksa_lab td, #forTable_periksa_lab th, #forTable_periksa_lab td {
  white-space: nowrap; 
}
.dataTables_wrapper th, .dataTables_wrapper td {
  white-space: nowrap; 
}
.pmd-datatable-pagination {
  padding-top: 10px !important;
}
.dt-length {
  display: inline;
}
.dt-paging {
  display: inline;
  float: right;
}
@media (max-width:767px) {
  .dt-length{
    display: none !important;
  }
}
/* table input {
    width: 50px;
} */
</style>
<div class="modal-content">
    <div class="modal-header">
      <h4 class="modal-title"><span id="modal-title">Edit Data Periksa Lab</span></h4>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body">
        <form id="form_periksa_lab">
            <input type="hidden" class="form-control" name="typeact" id="typeact" value="add" /> 
            <div class='row gx-3'>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='no_rawat'>No Rawat</label>
                    <input type='text' class='form-control' id='no_rawat' name='no_rawat' value="{?=revertNoRawat(parseUrl()[2])?}" />
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='tgl_periksa'>Tgl Periksa</label>
                    <input type='text' class='form-control' id='tgl_periksa' name='tgl_periksa' value="{?=date('Y-m-d')?}" />
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='jam'>Jam</label>
                    <input type='text' class='form-control' id='jam' name='jam' value="{?=date('H:i:s')?}" />    
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='dokter_perujuk'>Dokter Perujuk</label>
                    <select class="form-select" name="dokter_perujuk" id="dokter_perujuk">
                        <option value="">Select</option>
                        {loop: $periksalab.dokter}
                        <option value="{$value.kd_dokter}">{$value.nm_dokter}</option>
                        {/loop}
                    </select>
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='kd_dokter'>Kd Dokter</label>
                    <select class="form-select" name="kd_dokter" id="kd_dokter">
                        <option value="">Select</option>
                        {loop: $periksalab.dokter}
                        <option value="{$value.kd_dokter}">{$value.nm_dokter}</option>
                        {/loop}
                    </select>
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='nip'>Nip</label>
                    <select class="form-select" name="nip" id="nip">
                        <option value="">Select</option>
                        {loop: $periksalab.petugas}
                        <option value="{$value.nip}">{$value.nama}</option>
                        {/loop}
                    </select>
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='kategori'>Kategori</label>
                    <select name="kategori" id="kategori" class="form-select">
                        <option value="">Select</option>
                        <option value="PK">Patologi Klinik</option>
                        <option value="PA">Patologi Anatomi</option>
                    </select>
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='status'>Status</label>
                    <select name="status" id="status" class="form-select">
                        <option value="">Select</option>
                        <option value="Ralan">Rawat Jalan</option>
                        <option value="Ranap">Rawat Inap</option>
                    </select>
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-3 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='kd_jenis_prw'>Kd Jenis Prw</label>
                    <select class="form-select" name="kd_jenis_prw" id="kd_jenis_prw_lab">
                        <option value="">Select</option>
                        {loop: $periksalab.jns_perawatan_lab} 
                            <option value="{$value.kd_jenis_prw}">{$value.nm_perawatan}</option>
                        {/loop}
                    </select>
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='bagian_rs'>Bagian Rs</label>
                    <input type='text' class='form-control' id='bagian_rs' name='bagian_rs' />
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='bhp'>Bhp</label>
                    <input type='text' class='form-control' id='bhp' name='bhp' />
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='tarif_perujuk'>Tarif Perujuk</label>
                    <input type='text' class='form-control' id='tarif_perujuk' name='tarif_perujuk' />
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='tarif_tindakan_dokter'>Tarif Tindakan Dokter</label>
                    <input type='text' class='form-control' id='tarif_tindakan_dokter' name='tarif_tindakan_dokter' />
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='tarif_tindakan_petugas'>Tarif Tindakan Petugas</label>
                    <input type='text' class='form-control' id='tarif_tindakan_petugas' name='tarif_tindakan_petugas' />
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='kso'>Kso</label>
                    <input type='text' class='form-control' id='kso' name='kso' />
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='menejemen'>Menejemen</label>
                    <input type='text' class='form-control' id='menejemen' name='menejemen' />
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='biaya'>Biaya</label>
                    <input type='text' class='form-control' id='biaya' name='biaya' />
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='jk'>Jenis Kelamin</label>
                    <select name="jk" id="jk" class="form-select">
                        <option value="">Select</option>
                        <option value="L" {if: $periksalab.pasien.jk == 'L'}selected{/if}>Laki-Laki</option>
                        <option value="P" {if: $periksalab.pasien.jk == 'P'}selected{/if}>Perempuan</option>
                    </select>
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-3 col-lg-4 col-sm-6'>
                    <div class='mb-3'>
                    <label class='form-label' for='umur'>Umur</label>
                    <select name="umur" id="umur" class="form-select">
                        <option value="">Select</option>
                        <option value="D" {if: $periksalab.reg_periksa.umurdaftar > '16'}selected{/if}>Dewasa</option>
                        <option value="A" {if: $periksalab.reg_periksa.umurdaftar < '16'}selected{/if}>Anak-Anak</option>
                    </select>
                    <div class='invalid-feedback error'></div>
                    </div>
                </div>
                <div class='col-xxl-12 col-lg-12 col-sm-12'>
                    <div class='mb-3'>
                        <div id="tables-template-lab">   
                            <div id="loading"></div>
                            <div class="tables-template-lab">
                            </div>
                        </div>        
                    </div>
                </div>
                <div class='col-xxl-12 col-lg-12 col-sm-12'>
                    <div class='mb-3'>
                    <label class='form-label' for=''></label>
                    <button type="submit" class="btn btn-success">Submit</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    $(document).ready(function () {
        $('select').selectator();
        $('#kd_jenis_prw_lab').on('change', function() {
            var kd_jnis_prw = $('#kd_jenis_prw_lab option:selected').val();
            var api = mlite.url + '/reg_periksa/jnsperawatanlab/' + kd_jnis_prw + '?t=' + mlite.token;
            $.ajax({
            url:api,
            method:'GET',
            cache:false,
            type:"text/json"
        })
        .always(function(){
            $('#loading').html('Load Data Template Perawtan Lab...');
        })
        .done(function(evt) {
            // Set timeout for lazy loading
            setTimeout(function(){
                var result = JSON.parse(evt);
                $('#bagian_rs').val(result.bagian_rs);
                $('#bhp').val(result.bhp);
                $('#tarif_perujuk').val(result.tarif_perujuk);
                $('#tarif_tindakan_dokter').val(result.tarif_tindakan_dokter);
                $('#tarif_tindakan_petugas').val(result.tarif_tindakan_petugas);
                $('#menejemen').val(result.menejemen);
                $('#kso').val(result.kso);
                $('#biaya').val(result.total_byr);
                var result = result.template_laboratorium;
                // console.log(result.bagian_rs);
                var html = '';
                html += '<div class="tables-template-lab-content">';
                if(result.length > 0) {  
                    html +='<table class="table table-striped table-hover">'
                            +'<thead>'
                            +'<tr>'
                            +'<th><input class="form-check-input" type="checkbox" id="id_template_all"></th>'
                            // +'<th>Kd Jenis Prw</th>'
                            // +'<th>ID Template</th>'
                            +'<th>Pemeriksaan</th>'
                            +'<th>Satuan</th>'
                            +'<th>Nilai</th>'
                            +'<th>Keterangan</th>'
                            +'</tr>'
                            +'</thead>'
                            +'<tbody>';
                        for(var i=0;i < result.length; i++) {
                            html +='<tr>'
                                +'<td><input class="form-check-input" type="checkbox" name="id_template[]" id="id_template" value="'+result[i].id_template+'"></td>'
                                // +'<td>'+result[i].kd_jenis_prw+'</td>'
                                // +'<td>'+result[i].id_template+'</td>'
                                +'<td>'+result[i].Pemeriksaan+'</td>'
                                +'<td>'+result[i].satuan+'</td>'
                                +'<td><input class="form-control" name="nilai[]"></td>'
                                +'<td><input class="form-control" name="keterangan[]"></td>'
                                +'</tr>';
                        }
                    html +='</tbody></table>';
                } else {
                    html += '<div>Tidak ada data template perawatan lab...</div>';
                }

                html +='</div>';

                // Set all content
                $('.tables-template-lab').html(html);

                $('#id_template_all').click(function() {
                    if(this.checked) {
                        $('table').find('input:checkbox').prop('checked',true); 
                    }
                    else {
                        $('table').find('input:checkbox').prop('checked',false); 
                    }
                });
                
                $('input:checkbox:not(#id_template_all)').click(function() {
                    if(!this.checked) {
                        $('#id_template_all').prop('checked',false); 
                    }
                    else {
                        var numChecked = $('input:checkbox:checked:not(#id_template_all)').length;
                        var numTotal = $('input:checkbox:not(#id_template_all)').length;
                        if(numTotal == numChecked) {
                            $('input[type=checkbox]').prop('checked',true); 
                        }
                    }
                });        

            },1000); 
        })
        .fail(function() {
            alert('Error : Failed to reach API Url or check your connection');
        })
        .then(function(evt){
            setTimeout(function(){        
                $('#loading').hide();          
            },1000);
        });

        });    
            
        $('#form_periksa_lab').submit(function (e) {
            e.preventDefault();
            var formData = $(this).serialize();
            console.log(formData);
            $.ajax({
                url: "{?=url(['periksa_lab', 'aksi'])?}",
                type: "POST",
                data: formData,
                success: function (data) {
                    data = JSON.parse(data);
                    var audio = new Audio('{?=url()?}/assets/sound/' + data.status + '.mp3');
                    audio.play();
                    if(data.status === 'success') {
                        bootbox.alert('<span class="text-success">' + data.msg + '</span>');
                        $("#modal_periksa_lab").modal('hide');
                    } else {
                        bootbox.alert('<span class="text-danger">' + data.msg + '</span>');
                    }    
                    if(typeof ws != 'undefined' && typeof ws.readyState != 'undefined' && ws.readyState == 1){
                        let payload = {
                            'action' : typeact
                        }
                        ws.send(JSON.stringify(payload));
                    } 
                    // var_tbl_periksa_lab.draw();
                }
            });
        });
        
    });
</script>